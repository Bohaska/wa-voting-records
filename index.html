---
layout: default
title: WA Voting Records
custom_scripts: |
    <script>
        let allResolutions = []; // Array version
        let allVotes = [];

        /** Fetches and processes resolution and vote data using the shared loader. */
        async function loadData() {
            try {
                const data = await loadAllData();
                allResolutions = data.resolutionsArray;
                allVotes = data.allVotes;

                populateTable(allResolutions);

                // Check for URL parameter for direct link from nation-search.html
                const urlParams = new URLSearchParams(window.location.search);
                const prefillId = urlParams.get('id');
                if (prefillId) {
                    showDetailView(prefillId);
                }

            } catch (error) {
                console.error("Error initializing index page:", error);
                document.getElementById('resolutions-table-body').innerHTML = '<tr><td colspan="5">Error loading data. Check console for details.</td></tr>';
            }
        }

        /** Populates the resolution table with filtered or all data. */
        function populateTable(resList) {
            const tbody = document.getElementById('resolutions-table-body');
            tbody.innerHTML = '';

            // Sort by promoted timestamp descending
            resList.sort((a, b) => parseInt(b.promoted) - parseInt(a.promoted));

            resList.forEach((res, index) => {
                const row = tbody.insertRow();
                row.className = (index % 2 === 1) ? 'grey-background' : '';

                row.insertCell().textContent = res.date_part;
                row.insertCell().textContent = getChamber(res.council);

                let cell = row.insertCell();
                const link = document.createElement('a');
                link.href = "#";
                link.textContent = res.name;
                link.onclick = (e) => {
                    e.preventDefault();
                    showDetailView(res.id);
                };
                cell.appendChild(link);

                row.insertCell().innerHTML = generateAuthorLinksHTML(res.proposed_by);
                row.insertCell().innerHTML = `${generateAuthorLinksHTML(res.coauthor)}`;
            });
        }

        /** Filters the resolutions table based on author and keyword input. */
        function filterResolutions() {
            const keyword = document.getElementById('id_keyword').value.toLowerCase();
            const author = document.getElementById('id_author_name').value.toLowerCase();

            const filtered = allResolutions.filter(res => {
                const titleMatch = res.name.toLowerCase().includes(keyword);
                const authorMatch = res.proposed_by.toLowerCase().includes(author) ||
                    (res.coauthor && res.coauthor.toLowerCase().includes(author));
                return titleMatch && authorMatch;
            });
            populateTable(filtered);
        }

        /** Shows the detailed view for a specific resolution ID. */
        function showDetailView(resId) {
            const res = allResolutions.find(r => r.id === resId);
            if (!res) return;

            document.getElementById('detail-title').textContent = res.name;
            const chamber = getChamber(res.council);
            document.getElementById('detail-metadata').innerHTML =
                `The ${chamber} resolution (ID: ${res.id}) was authored by ${generateAuthorLinksHTML(res.proposed_by)} ` +
                (res.coauthor ? `(Co-authors: ${generateAuthorLinksHTML(res.coauthor)}) ` : '') +
                `and promoted on ${res.date_part} (UTC).`;

            const resLink = `https://ifly6.no-ip.org/wa-proposal/${res.id}/`;
            document.getElementById('detail-link').href = resLink;

            const votersFor = [];
            const votersAgainst = [];

            allVotes.forEach(nationVoteRecord => {
                const nationId = nationVoteRecord.nation_id;
                const vote = nationVoteRecord[resId];
                if (vote === '1') {
                    votersFor.push(nationId);
                } else if (vote === '0') {
                    votersAgainst.push(nationId);
                }
            });

            const nfObject = new Intl.NumberFormat('en-US')
            const totalVoters = votersFor.length + votersAgainst.length
            document.getElementById('voted-for-hd').textContent = `Nations Voted FOR (${nfObject.format(votersFor.length)} nations, ${(votersFor.length/(totalVoters)).toFixed(2)}%)`
            document.getElementById('voted-against-hd').textContent = `Nations Voted AGAINST (${nfObject.format(votersAgainst.length)} nations, ${(votersAgainst.length/(totalVoters)).toFixed(2)}%)`

            const ulFor = document.getElementById('voters-for');
            const ulAgainst = document.getElementById('voters-against');
            const mapVoter = n => `<li><a href="nation-search.html?id=${encodeURIComponent(n)}">${n.replace(/_/g, ' ')}</a></li>`;
            ulFor.innerHTML = votersFor.map(mapVoter).join('');
            ulAgainst.innerHTML = votersAgainst.map(mapVoter).join('');

            document.getElementById('resolutions-list-view').style.display = 'none';
            document.getElementById('resolution-detail-view').style.display = 'block';
            window.scrollTo(0, 0);
        }

        /** Switches back to the main list view. */
        function showListView() {
            document.getElementById('resolution-detail-view').style.display = 'none';
            document.getElementById('resolutions-list-view').style.display = 'block';
            window.scrollTo(0, 0);
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
---
<div id="resolutions-list-view">
    <h1>Browse resolutions</h1>
    <p>The following is a list of all WA voting records recorded. Click on the <i>title</i> of the
        resolution for more information.</p>

    <h2>Search by resolution</h2>
    <form onsubmit="event.preventDefault(); filterResolutions();">
        <table>
            <tbody>
            <tr>
                <th><label for="id_author_name">Author name:</label></th>
                <td>
                    <input type="text" id="id_author_name" maxlength="40" aria-describedby="id_author_name_helptext">
                    <br>
                    <span class="helptext" id="id_author_name_helptext">Search for an author (also includes coauthors)</span>
                </td>
            </tr>
            <tr>
                <th><label for="id_keyword">Keyword:</label></th>
                <td>
                    <input type="text" id="id_keyword" maxlength="60" aria-describedby="id_keyword_helptext">
                    <br>
                    <span class="helptext" id="id_keyword_helptext">Search for keyword appearing in proposal title.</span>
                </td>
            </tr>
            </tbody>
        </table>
        <input type="submit" value="Filter" onclick="filterResolutions()">
        <input type="button" value="Clear" onclick="document.getElementById('id_author_name').value=''; document.getElementById('id_keyword').value=''; filterResolutions();">
    </form>
    <br>

    <table class="decorated">
        <thead>
        <tr>
            <th>Date (UTC)</th>
            <th>Chamber</th>
            <th>Title</th>
            <th>Author</th>
            <th>Co-authors</th>
        </tr>
        </thead>
        <tbody id="resolutions-table-body">
        <tr><td colspan="5">Loading data...</td></tr>
        </tbody>
    </table>

    <p><span style="font-size: 12px">Date based on resolution promotion time (UTC).</span></p>
</div>

<!-- Resolution View (Client-Side) -->
<div id="resolution-detail-view" style="display: none;">
    <button onclick="showListView()" style="margin-bottom: 20px;">‚Üê Back to Resolutions List</button>
    <h1 id="detail-title"></h1>
    <p id="detail-metadata"></p>
    <p>Full resolution text and complete history is available <a id="detail-link" target="_blank" href="#">here</a>.</p>

    <div style="display: flex; justify-content: space-around;">
        <div style="width: 45%;">
            <h2 id="voted-for-hd">Nations Voted FOR</h2>
            <ul id="voters-for" style="list-style-type: none; padding: 0;"></ul>
        </div>
        <div style="width: 45%;">
            <h2 id="voted-against-hd">Nations Voted AGAINST</h2>
            <ul id="voters-against" style="list-style-type: none; padding: 0;"></ul>
        </div>
    </div>

    <p style="margin-top: 30px;">
        <a id="download-csv" href="votes.csv" download="votes.csv">Download Full Votes CSV</a>
    </p>
</div>